# Maintainer: Panda <panda@bredos.org>

pkgname=edge2-post-install
pkgver=20$(date +%y%m%d)
pkgrel=2
pkgdesc="Fixes for Khadas Edge 2"
depends=('ap6275p-firmware' 'iwd')
arch=('aarch64')
url="https://www.khadas.com/"
license=('GPL')
source=('bluetooth-khadas.service'
        'bluetooth-khadas.sh'
        'fan.service'
        'fan.sh'
        'hciattach'
        'brcm_patchram_plus')
md5sums=('b9f7943628bcfe57b66431e21fd995f9'
         '63217a482cca53b46e7b78fddbbaf0b4'
         '9dbb65a4d934950a2c86df2c95f74053'
         'f7fa55ccb7e74560a06dea1de960911d'
         'caf073c3aed14ba153c8dc56f44a2ea9'
         '8553eae65a627c31cb0152e0eeb9dd56')
backup=("etc/NetworkManager/conf.d/wifi_backend.conf")

package() {

    # to /usr/local/bin
    install -D -m 0755 "${srcdir}/fan.sh" -t "${pkgdir}/usr/local/bin"
    install -D -m 0755 "${srcdir}/hciattach" -t "${pkgdir}/usr/local/bin"
    install -D -m 0755 "${srcdir}/bluetooth-khadas.sh" -t "${pkgdir}/usr/local/bin"
    install -D -m 0755 "${srcdir}/brcm_patchram_plus" -t "${pkgdir}/usr/local/bin"

    #  to /usr/lib/systemd/system
    install -D -m 0644 "${srcdir}/fan.service" -t "${pkgdir}/usr/lib/systemd/system"
    install -D -m 0644 "${srcdir}/bluetooth-khadas.service" -t "${pkgdir}/usr/lib/systemd/system"

    # to /etc
    mkdir -p "${pkgdir}/etc/NetworkManager/conf.d"
    echo -e "[device]\nwifi.backend=iwd" >  "${pkgdir}/etc/NetworkManager/conf.d/wifi_backend.conf"
    ln -s /usr/lib/firmware "${pkgdir}/etc/firmware"
}