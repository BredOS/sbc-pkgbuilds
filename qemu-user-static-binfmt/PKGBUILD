# Maintainer: Your Name <your.email@example.com>

pkgname=qemu-user-static-binfmt
pkgver=10.0.2
pkgrel=5
pkgdesc="Binary format rules for QEMU static user mode emulation"
arch=('aarch64')
url="https://www.qemu.org/"
license=('BSD-2-Clause' 'BSD-2-Clause-Patent' 'BSD-3-Clause' 'CC0-1.0' 'FSFAP' 
         'GPL-1.0-or-later' 'GPL-2.0-only' 'GPL-2.0-or-later' 'ISC' 
         'LGPL-2.0-or-later' 'LGPL-2.1-or-later' 'MIT')
depends=("qemu-user-static")
provides=('qemu-user-binfmt-provider')
conflicts=('qemu-user-binfmt-provider')
source=("https://pkgbuild.org/archlinux/extra/os/x86_64/${pkgname}-${pkgver}-1-x86_64.pkg.tar.zst"
        "qemu-x86_64-static.conf")
noextract=("${pkgname}-${pkgver}-1-x86_64.pkg.tar.zst")

package() {
    cd "$srcdir"
    
    # Extract the original package
    tar -xf "${pkgname}-${pkgver}-1-x86_64.pkg.tar.zst"

    # Copy all files to the package directory
    cp -r usr/ "$pkgdir/"
    local remove_archs=("sh4" "sh4eb" "xtensa" "xtensaeb" "hppa" "hexagon" "m68k" "or1k" "microblaze" "microblazeel" "aarch64" "aarch64_be")
    for arch in "${remove_archs[@]}"; do
        rm -rf "$pkgdir/usr/lib/binfmt.d/qemu-$arch-static.conf"
    done
    for i in ls "$pkgdir/usr/lib/binfmt.d/"*; do
        if [ -f "$i" ]; then
            filename=$(basename "$i")
            dirname=$(dirname "$i")
            mv "$i" "$dirname/40-$filename"
        fi
    done
    install -Dm644 "${srcdir}/qemu-x86_64-static.conf" "$pkgdir/usr/lib/binfmt.d/40-qemu-x86_64-static.conf"
}

# Generate checksums with: makepkg -g
sha256sums=('SKIP'
            'SKIP')
